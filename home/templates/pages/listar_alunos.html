{% load static %}
<!DOCTYPE html>
<html lang="pt-br">

<head>
    {% include 'partials/_head.html' %}

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <!-- Fuse.js -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

    <style>
        body { background: #f7f7f7; }

        .titulo-pagina {
            background: #6c757d;
            color: #fff;
            font-weight: bold;
            font-size: 1.4rem;
            padding: .85rem 1.2rem;
            border-radius: 6px;
            margin-bottom: 1.4rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        @media(max-width:992px) {
            .dashboard-cards { grid-template-columns: repeat(2, 1fr); }
        }

        @media(max-width:576px) {
            .dashboard-cards { grid-template-columns: 1fr; }
        }

        .dash-card {
            background: #fff;
            padding: 1.2rem 1.3rem;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #fab982;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }

        .dash-card .icone-card {
            font-size: 2rem;
            color: #fab982;
            margin-bottom: .5rem;
        }

        .dash-card h4 {
            font-size: 1rem;
            margin-bottom: .35rem;
            color: #444;
        }

        .dash-card .valor {
            font-size: 1.7rem;
            font-weight: bold;
            color: #444;
        }

        .list-controls {
            display: flex;
            flex-direction: column;
            gap: .75rem;
            margin-bottom: 1.4rem;
        }

        .list-controls input,
        .list-controls select {
            width: 100% !important;
            height: 44px;
            border: 2px solid #fab982 !important;
            border-radius: 6px;
        }

        #autocompleteBox {
            border: 2px solid #fab982;
            border-top: none;
            position: absolute;
            background: #fff;
            z-index: 999;
            width: 100%;
            display: none;
            max-height: 220px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .15);
            top: 44px;
        }

        #autocompleteBox div {
            padding: 8px 10px;
            cursor: pointer;
        }

        #autocompleteBox div:hover {
            background: #f5f5f5;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #fab982;
        }

        table thead th {
            padding: 12px;
            background: #fef6ef;
            border-bottom: 2px solid #fab982;
            font-weight: 600;
            cursor: pointer;
            color: #444;
        }

        table tbody td { padding: 10px 12px; }

        table tbody tr:hover { background: #fafafa; }

        mark {
            background: #ffe4b3;
            padding: 0 2px;
        }
    </style>
</head>

<body>

{% include 'partials/_nav.html' %}

<section class="py-5">
<div class="container">

<div class="titulo-pagina">Lista de Alunos</div>

<div class="dashboard-cards">
    <div class="dash-card">
        <div class="icone-card"><i class="bi bi-people-fill"></i></div>
        <h4>Total</h4>
        <div class="valor" id="cardTotal">0</div>
    </div>
    <div class="dash-card">
        <div class="icone-card"><i class="bi bi-person-check-fill"></i></div>
        <h4>Ativos</h4>
        <div class="valor" id="cardAtivos">0</div>
    </div>
    <div class="dash-card">
        <div class="icone-card"><i class="bi bi-person-x-fill"></i></div>
        <h4>Inativos</h4>
        <div class="valor" id="cardInativos">0</div>
    </div>
    <div class="dash-card">
        <div class="icone-card"><i class="bi bi-calendar-event-fill"></i></div>
        <h4>Aniversariantes do mÃªs</h4>
        <div class="valor" id="cardNivers">0</div>
    </div>
</div>

<div class="list-controls">
    <input id="filtroAluno" class="form-control"
           placeholder="ðŸ” Buscar aluno, CPF, matrÃ­cula, responsÃ¡vel...">
    <div id="autocompleteBox"></div>

    <select id="filtroStatus" class="custom-select">
        <option value="">Status: todos</option>
        <option value="ativo">Ativos</option>
        <option value="inativo">Inativos</option>
    </select>

    <select id="filtroTurma" class="custom-select">
        <option value="">Turma: todas</option>
    </select>

    <select id="pageSize" class="custom-select">
        <option value="10">Exibir 10</option>
        <option value="25" selected>Exibir 25</option>
        <option value="50">Exibir 50</option>
        <option value="100">Exibir 100</option>
    </select>

    <button id="clearFilters" class="btn btn-secondary btn-sm">
        Limpar filtros
    </button>
</div>

<table id="tabelaAlunos">
<thead>
<tr>
    <th data-sort="matricula">MatrÃ­cula</th>
    <th data-sort="turma">Turma</th>
    <th data-sort="nome">Nome</th>
    <th data-sort="responsaveis">ResponsÃ¡veis</th>
    <th data-sort="telefone">Telefone</th>
    <th data-sort="nee">NEE</th>
    <th data-sort="ativo">Status</th>
    <th>AÃ§Ãµes</th>
</tr>
</thead>

<tbody id="tabelaAlunosBody">
<script id="alunos-data" type="application/json">
{{ alunos_json|safe }}
</script>
</tbody>
</table>

<div class="pagination-bar mt-3 d-flex justify-content-between align-items-center">
    <div id="resultsInfo">Mostrando 0â€“0 de 0</div>
    <ul class="pagination mb-0">
        <li class="page-item"><button id="firstPage" class="page-link">Â«</button></li>
        <li class="page-item"><button id="prevPage" class="page-link">â€¹</button></li>
        <li class="page-item disabled"><span id="pageIndicator" class="page-link">1 / 1</span></li>
        <li class="page-item"><button id="nextPage" class="page-link">â€º</button></li>
        <li class="page-item"><button id="lastPage" class="page-link">Â»</button></li>
    </ul>
</div>

</div>
</section>

<script>
const alunos = JSON.parse(document.getElementById("alunos-data").textContent);
const userRole = "{{ user.role }}";
const turmasPermitidas = JSON.parse(`{{ turmas_usuario|safe }}`);

function normaliza(t) {
    return (t || "")
        .toString()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase();
}

function turmaLabel(a) {
    if (!a.turma) return "";
    return a.turma.nome || a.turma.sigla || "";
}

function highlight(text, term) {
    if (!term) return text;
    const regex = new RegExp(`(${term})`, "gi");
    return text.replace(regex, `<mark>$1</mark>`);
}

function alunosPermitidos() {
    if (["diretor", "coordenador", "secretaria"].includes(userRole))
        return alunos;

    if (userRole === "professor") {
        return alunos.filter(a => turmasPermitidas.includes(turmaLabel(a)));
    }

    return alunos;
}

/* ===============================
   FUSE â€“ apenas texto livre
================================ */
const fuse = new Fuse(alunos, {
    threshold: 0.3,
    ignoreLocation: true,
    keys: [
        "nome",
        "cpf",
        "responsaveis.nome",
        "responsaveis.cpf",
        "responsaveis.telefone",
        "cidade",
        "bairro",
        "turma.nome"
    ]
});

let searchTerm = "";
let statusFilter = "";
let turmaFilter = "";
let sortKey = "";
let sortDir = "asc";
let pageSize = 25;
let currentPage = 1;

/* ===============================
   BUSCA INTELIGENTE
================================ */
function aplicarBusca() {
    const termo = normaliza(searchTerm);
    let lista = alunosPermitidos();

    if (!termo) return lista;

     /* ðŸ”¹ BUSCA POR ANIVERSARIANTES */
    if (termo.startsWith("aniver")) {
        const mesAtual = new Date().getMonth();
        return lista.filter(a => {
            if (!a.data_nascimento) return false;
            return new Date(a.data_nascimento).getMonth() === mesAtual;
        });
    }

    /* ðŸ”¹ BUSCA POR MATRÃCULA (EXATA / PROGRESSIVA) */
    const pareceMatricula = /^[a-zA-Z0-9]+$/.test(termo);

    if (pareceMatricula) {
        return lista.filter(a =>
            normaliza(a.matricula).startsWith(termo)
        );
    }

    /* ðŸ”¹ BUSCA TEXTUAL NORMAL (Fuse) */
    return fuse.search(termo).map(r => r.item);
}

function filtrarSimples(lista) {
    return lista.filter(a => {
        if (statusFilter === "ativo" && !a.ativo) return false;
        if (statusFilter === "inativo" && a.ativo) return false;
        if (turmaFilter && turmaLabel(a) !== turmaFilter) return false;
        return true;
    });
}

function ordenarLista(lista) {
    if (!sortKey) return lista;

    return lista.slice().sort((a, b) => {
        let av = sortKey === "turma" ? turmaLabel(a) : a[sortKey];
        let bv = sortKey === "turma" ? turmaLabel(b) : b[sortKey];

        av = normaliza(av);
        bv = normaliza(bv);

        if (av < bv) return sortDir === "asc" ? -1 : 1;
        if (av > bv) return sortDir === "asc" ? 1 : -1;
        return 0;
    });
}

function atualizarCards(listaTotal) {
    const total = listaTotal.length;
    const ativos = listaTotal.filter(a => a.ativo).length;
    const inativos = total - ativos;

    const mes = new Date().getMonth();
    const aniversario = listaTotal.filter(a => {
        if (!a.data_nascimento) return false;
        return new Date(a.data_nascimento).getMonth() === mes;
    }).length;

    document.getElementById("cardTotal").textContent = total;
    document.getElementById("cardAtivos").textContent = ativos;
    document.getElementById("cardInativos").textContent = inativos;
    document.getElementById("cardNivers").textContent = aniversario;
}

function renderizarTabela(pagina = 1) {
    let lista = aplicarBusca();
    lista = filtrarSimples(lista);
    lista = ordenarLista(lista);

    atualizarCards(alunos);

    const total = lista.length;
    const totalPaginas = Math.max(1, Math.ceil(total / pageSize));
    currentPage = Math.min(Math.max(1, pagina), totalPaginas);

    const ini = (currentPage - 1) * pageSize;
    const fim = ini + pageSize;

    const tbody = document.getElementById("tabelaAlunosBody");
    tbody.innerHTML = "";

    lista.slice(ini, fim).forEach(a => {
        const resp = a.responsaveis?.[0]?.nome || "";

        tbody.insertAdjacentHTML("beforeend", `
            <tr>
                <td>${a.matricula}</td>
                <td>${turmaLabel(a)}</td>
                <td>${a.nome}</td>
                <td>${resp}</td>
                <td>${a.responsaveis?.[0]?.telefone || ""}</td>
                <td>${a.possui_necessidade_especial ? "ðŸ§©" : "â€“"}</td>
                <td>
                    ${a.ativo
                        ? "<span class='badge badge-success'>Ativo</span>"
                        : "<span class='badge badge-secondary'>Inativo</span>"
                    }
                </td>
                <td style="white-space:nowrap;">
                <a href="/alunos/${a.id}/editar/" class="btn btn-info btn-sm mr-1">Editar</a>
                <a href="/alunos/${a.id}/pdf/" target="_blank" class="btn btn-secondary btn-sm">
    Imprimir
  </a>
</td>
            </tr>
        `);
    });

    document.getElementById("resultsInfo").textContent =
        total ? `Mostrando ${ini + 1}â€“${Math.min(fim, total)} de ${total}`
              : "Nenhum resultado";

    document.getElementById("pageIndicator").textContent =
        `${currentPage} / ${totalPaginas}`;
}

/* EVENTOS */
document.getElementById("filtroAluno").oninput = e => {
    searchTerm = e.target.value;
    renderizarTabela(1);
};

document.getElementById("filtroStatus").onchange = e => {
    statusFilter = e.target.value;
    renderizarTabela(1);
};

document.getElementById("filtroTurma").onchange = e => {
    turmaFilter = e.target.value;
    renderizarTabela(1);
};

document.getElementById("pageSize").onchange = e => {
    pageSize = parseInt(e.target.value);
    renderizarTabela(1);
};

document.getElementById("clearFilters").onclick = () => {
    searchTerm = "";
    statusFilter = "";
    turmaFilter = "";
    document.getElementById("filtroAluno").value = "";
    renderizarTabela(1);
};

document.getElementById("firstPage").onclick = () => renderizarTabela(1);
document.getElementById("prevPage").onclick = () => renderizarTabela(currentPage - 1);
document.getElementById("nextPage").onclick = () => renderizarTabela(currentPage + 1);
document.getElementById("lastPage").onclick = () => renderizarTabela(9999);

document.querySelectorAll("th[data-sort]").forEach(th => {
    th.onclick = () => {
        const key = th.dataset.sort;
        sortDir = sortKey === key && sortDir === "asc" ? "desc" : "asc";
        sortKey = key;
        renderizarTabela(1);
    };
});
renderizarTabela(1);
</script>
</body>
</html>
